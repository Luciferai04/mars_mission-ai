<!DOCTYPE html>
<html>
  <head>
    <meta charset="UTF-8" />
    <meta name="viewport" content="width=device-width, initial-scale=1.0" />
    <title>Mars 3D Terrain</title>
    <style>
      body { margin: 0; overflow: hidden; background: #000; color: #fff; }
      #info { position: absolute; top: 10px; left: 10px; z-index: 1; }
    </style>
  </head>
  <body>
    <div id="info">Mars 3D Terrain Viewer</div>
    <canvas id="c"></canvas>
    <script src="https://cdn.jsdelivr.net/npm/three@0.161.0/build/three.min.js"></script>
    <script>
      const canvas = document.getElementById('c');
      const renderer = new THREE.WebGLRenderer({ canvas, antialias: true });
      const scene = new THREE.Scene();
      const camera = new THREE.PerspectiveCamera(60, 2, 0.1, 2000);
      camera.position.set(0, 150, 250);
      const light = new THREE.DirectionalLight(0xffffff, 1);
      light.position.set(100, 200, 100);
      scene.add(light);
      scene.add(new THREE.AmbientLight(0x404040));

      async function loadHeightmap() {
        const res = await fetch('/heightmap');
        const hm = await res.json();
        const width = hm.width, height = hm.height;
        const geom = new THREE.PlaneGeometry(width, height, width-1, height-1);
        const pos = geom.attributes.position;
        for (let i = 0; i < pos.count; i++) {
          const x = i % width;
          const y = Math.floor(i / width);
          const z = hm.data[y][x] * 80.0; // scale
          pos.setZ(i, z);
        }
        pos.needsUpdate = true;
        geom.computeVertexNormals();
        const mat = new THREE.MeshStandardMaterial({ color: 0x884422, wireframe: false });
        const mesh = new THREE.Mesh(geom, mat);
        mesh.rotation.x = -Math.PI / 2;
        scene.add(mesh);
      }

      function resizeRendererToDisplaySize(renderer) {
        const canvas = renderer.domElement;
        const width = canvas.clientWidth;
        const height = canvas.clientHeight;
        const needResize = canvas.width !== width || canvas.height !== height;
        if (needResize) renderer.setSize(width, height, false);
        return needResize;
      }

      function render() {
        if (resizeRendererToDisplaySize(renderer)) {
          const canvas = renderer.domElement;
          camera.aspect = canvas.clientWidth / canvas.clientHeight;
          camera.updateProjectionMatrix();
        }
        renderer.render(scene, camera);
        requestAnimationFrame(render);
      }

      loadHeightmap().then(render);
      window.addEventListener('resize', () => renderer.setSize(window.innerWidth, window.innerHeight));
      renderer.setSize(window.innerWidth, window.innerHeight);
    </script>
  </body>
</html>
